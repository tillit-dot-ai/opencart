<?xml version="1.0" encoding="utf-8"?>
<modification>
  <name>Two Payment Gateway API</name>
  <code>two_default</code>
  <version>1.1.2</version>
  <author>Two</author>
  <link>https://two.inc</link>
  <file path="system/library/cart/customer.php">
  <operation error="log">
      <search>
        <![CDATA[private $address_id;]]>
      </search>
      <add position="after">
        <![CDATA[private $account_type;]]>
      </add>
    </operation>
    <operation error="log">
      <search>
        <![CDATA[$this->address_id = $customer_query->row['address_id'];]]>
      </search>
      <add position="after">
        <![CDATA[$this->account_type = $customer_query->row['account_type'];]]>
      </add>
    </operation>
    <operation error="log">
      <search>
        <![CDATA[public function getAddressId() {]]>
      </search>
      <add position="before">
        <![CDATA[public function getAccountType() {
      return $this->account_type;
    }]]>
      </add>
    </operation>
  </file>
  <file path="catalog/model/localisation/zone.php">
    <operation error="log">
      <search>
        <![CDATA[public function getZonesByCountryId($country_id) {]]>
      </search>
      <add position="after">
        <![CDATA[
        //Norway(160),UK(222)
        $countryList = array(222,160);
        if($this->config->get('payment_two_status') && $this->customer->getAccountType() == 'business' && in_array($country_id, $countryList)){
          return array();
        }]]>
      </add>
    </operation>
  </file>
  <file path="catalog/controller/account/register.php">
  <operation error="log">
      <search>
        <![CDATA[$data['column_left'] = $this->load->controller('common/column_left');]]>
      </search>
      <add position="before">
        <![CDATA[
        if($this->config->get('payment_two_status')){
          $this->language->load('extension/payment/two');
          $data['two_status'] = $this->config->get('payment_two_status');

          if (isset($this->request->post['account_type'])) {
            $data['account_type'] = $this->request->post['account_type'];
          } else {
            $data['account_type'] = 'business';
          }
          $data['config_country'] = $this->config->get('config_country_id');
          $this->language->load('account/register');
        }
    ]]>
      </add>
    </operation>
  </file>
  <file path="catalog/view/theme/default/template/account/register.twig">
    <operation error="log">
      <search>
        <![CDATA[{% for custom_field in custom_fields %}]]>
      </search>
      <add position="before">
        <![CDATA[{% if two_status %}
          <div class="form-group required">
            <label class="col-sm-2 control-label" for="input-country">{{ entry_account_type }}</label>
            <div class="col-sm-10">
              {% if account_type == 'personal' %}
              <label class="radio-inline">
                <input type="radio" name="account_type" value="personal" checked="checked" />
                {{ text_personal }}</label>
              <label class="radio-inline">
                <input type="radio" name="account_type" value="business" />
                {{ text_business }}</label>
              {% else %}
              <label class="radio-inline">
                <input type="radio" name="account_type" value="personal" />
                {{ text_personal }}</label>
              <label class="radio-inline">
                <input type="radio" name="account_type" value="business" checked="checked" />
                {{ text_business }}</label>
              {% endif %}
            </div>
          </div>{% endif %}
    ]]>
      </add>
    </operation>
    <operation error="log">
      <search>
        <![CDATA[{{ footer }}]]>
      </search>
      <add position="before">
        <![CDATA[
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
        <script type="text/javascript">
        $(document).ready(function() {
          var config_country = '{{ config_country }}';
          var billingPhoneInput;
          let billingPhoneInputField = document.querySelector("#input-telephone");
          if(config_country == 160 || config_country == '160'){
            billingPhoneInput = window.intlTelInput(billingPhoneInputField, {
              preferredCountries: ["no", "gb"],
              utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"
            });
          } else {
            billingPhoneInput = window.intlTelInput(billingPhoneInputField, {
              preferredCountries: ["gb", "no"],
              utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"
            });
          }
          
          if ($('#input-payment-telephone')) {
              billingPhoneInput.setNumber($('#input-telephone').val());
          }
        });
        </script>
        <style type="text/css">
        .iti--allow-dropdown{display: block;}
        .iti__selected-flag{height: 35px;}
        </style>
      ]]>
      </add>
    </operation>
  </file>
  <file path="catalog/controller/account/edit.php">
    <operation error="log">
      <search>
        <![CDATA[$data['back'] = $this->url->link('account/account', '', true);]]>
      </search>
      <add position="before">
        <![CDATA[
      if($this->config->get('payment_two_status')){
        $this->language->load('extension/payment/two');
        $data['two_status'] = $this->config->get('payment_two_status');

        if (isset($this->request->post['account_type'])) {
          $data['account_type'] = $this->request->post['account_type'];
        } elseif (!empty($customer_info)) {
          $data['account_type'] = $customer_info['account_type'];
        } else {
          $data['account_type'] = 'business';
        }
        $data['config_country'] = $this->config->get('config_country_id');
        $this->language->load('account/edit');
      }
    ]]>
      </add>
    </operation>
  </file>
  <file path="catalog/view/theme/default/template/account/edit.twig">
    <operation error="log">
      <search>
        <![CDATA[{% for custom_field in custom_fields %}]]>
      </search>
      <add position="before">
        <![CDATA[{% if two_status %}
          <div class="form-group required">
            <label class="col-sm-2 control-label" for="input-country">{{ entry_account_type }}</label>
            <div class="col-sm-10">
              {% if account_type == 'personal' %}
              <label class="radio-inline">
                <input type="radio" name="account_type" value="personal" checked="checked" />
                {{ text_personal }}</label>
              <label class="radio-inline">
                <input type="radio" name="account_type" value="business" />
                {{ text_business }}</label>
              {% else %}
              <label class="radio-inline">
                <input type="radio" name="account_type" value="personal" />
                {{ text_personal }}</label>
              <label class="radio-inline">
                <input type="radio" name="account_type" value="business" checked="checked" />
                {{ text_business }}</label>
              {% endif %}
            </div>
          </div>{% endif %}
    ]]>
      </add>
    </operation>
    <operation error="log">
      <search>
        <![CDATA[{{ footer }}]]>
      </search>
      <add position="before">
        <![CDATA[
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
        <script type="text/javascript">
        $(document).ready(function() {
          var config_country = '{{ config_country }}';
          var billingPhoneInput;
          let billingPhoneInputField = document.querySelector("#input-telephone");
          if(config_country == 160 || config_country == '160'){
            billingPhoneInput = window.intlTelInput(billingPhoneInputField, {
              preferredCountries: ["no", "gb"],
              utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"
            });
          } else {
            billingPhoneInput = window.intlTelInput(billingPhoneInputField, {
              preferredCountries: ["gb", "no"],
              utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"
            });
          }
          if ($('#input-payment-telephone')) {
              billingPhoneInput.setNumber($('#input-telephone').val());
          }
        });
        </script>
        <style type="text/css">
        .iti--allow-dropdown{display: block;}
        .iti__selected-flag{height: 35px;}
        </style>
      ]]>
      </add>
    </operation>
  </file>
  <file path="catalog/model/account/customer.php">
    <operation error="log">
      <search>
        <![CDATA[$customer_id = $this->db->getLastId();]]>
      </search>
      <add position="after">
        <![CDATA[
        if($this->config->get('payment_two_status')){
      if (isset($data['account_type'])) {
        $this->db->query("UPDATE `" . DB_PREFIX . "customer` SET account_type = '" . $this->db->escape($data['account_type']) . "' WHERE customer_id = '" . (int)$customer_id . "'");
      }
    }]]>
      </add>
    </operation>
    <operation error="log">
      <search>
        <![CDATA[public function editCustomer($customer_id, $data) {]]>
      </search>
      <add position="after">
        <![CDATA[
        if($this->config->get('payment_two_status')){
      if ($data['account_type']) {
        $this->db->query("UPDATE `" . DB_PREFIX . "customer` SET account_type = '" . $this->db->escape($data['account_type']) . "' WHERE customer_id = '" . (int)$customer_id . "'");
      }
    }
    ]]>
      </add>
    </operation>
  </file>

  <file path="catalog/controller/account/address.php">
    
    <operation error="log">
      <search>
        <![CDATA[$data['back'] = $this->url->link('account/address', '', true);]]>
      </search>
      <add position="before">
        <![CDATA[
      if($this->config->get('payment_two_status') && $this->customer->getAccountType() == 'business'){
        $data['two_status'] = $this->config->get('payment_two_status');

        $this->language->load('extension/payment/two');

        if (isset($this->request->post['company_id'])) {
          $data['company_id'] = $this->request->post['company_id'];
        }  elseif (!empty($address_info)) {
          $data['company_id'] = $address_info['company_id'];
        } else {
          $data['company_id'] = '';
        }

        $this->language->load('account/address');
      }
    ]]>
      </add>
    </operation>
    <operation error="log">
      <search>
        <![CDATA[if (isset($this->error['city'])) {]]>
      </search>
      <add position="before">
        <![CDATA[
         if (isset($this->error['company'])) {
          $data['error_company'] = $this->error['company'];
        } else {
          $data['error_company'] = '';
        }
        ]]>
      </add>
    </operation>
    <operation error="log">
      <search>
        <![CDATA[$country_info = $this->model_localisation_country->getCountry($this->request->post['country_id']);]]>
      </search>
      <add position="before">
        <![CDATA[
         if($this->config->get('payment_two_status') && $this->customer->getAccountType() == 'business'){
          if ($this->request->post['company_id'] == '' && in_array($this->request->post['country_id'], array(222,160))) {
            $this->error['company'] = 'Please select company from suggested list.';
          }
        }
        ]]>
      </add>
    </operation>
  </file>
  <file path="catalog/model/account/address.php">
    <operation error="log">
      <search>
        <![CDATA[if (!empty($data['default'])) {]]>
      </search>
      <add position="before">
        <![CDATA[
      if($this->config->get('payment_two_status')){
        if (!empty($data['company_id'])) {
          $this->db->query("UPDATE " . DB_PREFIX . "address SET company_id = '" . $this->db->escape($data['company_id']) . "' WHERE address_id = '" . (int)$address_id . "'");
        }
      }
    ]]>
      </add>
    </operation>
    <operation error="log">
      <search>
        <![CDATA['company'        => $address_query->row['company'],]]>
      </search>
      <add position="after">
        <![CDATA['company_id'        => $address_query->row['company_id'],]]>
      </add>
    </operation>
    
  </file>
  
  <file path="catalog/view/theme/default/template/account/address_form.twig">
    <operation error="log">
      <search>
        <![CDATA[<input type="text" name="company" value="{{ company }}" placeholder="{{ entry_company }}" id="input-company" class="form-control" />]]>
      </search>
      <add position="after">
        <![CDATA[{% if two_status %}{% if error_company %}<div class="text-danger">{{ error_company }}</div>
              {% endif %}</div></div><div class="form-group">
        <label class="col-sm-2 control-label" for="input-payment-company-id">{{ entry_company_id }}</label>
        <div class="col-sm-10"><input readonly placeholder="{{ text_autocomplete }}" type="text" name="company_id" value="{{ company_id }}" id="input-payment-company-id" class="form-control"/>{% endif %}]]>
      </add>
    </operation>
    <operation error="log">
      <search>
        <![CDATA[{{ footer }}]]>
      </search>
      <add position="before">
        <![CDATA[{% if two_status %}<script type="text/javascript"><!--
      $( window ).load(function() {
        $('#input-country').change();
      });
    $('#input-country').on('change', function() {
      let united_kingdom_id = 222;
      let norway = 160;
      if(united_kingdom_id == $(this).val() || norway == $(this).val()) {
        var $div = $('#input-company').closest('div[class^="form-group"]').addClass( "required");
      }else {
        var $div = $('#input-company').closest('div[class^="form-group"]').removeClass( "required");
      }
    });
    $('#input-company').on('keyup', function() {
      let united_kingdom_id = 222;
      let norway = 160;
      var countrycheck = $('#input-country').val();
      var comapnyname = $('#input-company').val();
    
      if((comapnyname).length > 2){
        if(countrycheck!=united_kingdom_id && countrycheck!=norway){
          //alert('Please select country Norway or United Kingdom to search');
        }else {
          $('input[name=\'company\']').parent().find('ul.dropdown-menu').remove();
          $('input[name=\'company\']').autocomplete({
            'source': function(request, response) {
              $.ajax({
                url: 'index.php?route=extension/payment/two/company&company=' + encodeURIComponent(request) + '&country_id=' + encodeURIComponent($('#input-country').val()),
                dataType: 'json',               
                success: function(json) {
                  if(json['success']){
                    json = json.data.items;
                    response($.map(json, function(item) {
                    return {
                      label: item['name'],
                      value: item['id']
                    }
                    }));
                  }
                }
              });
            },
            'select': function(item) {
              $('input[name=\'company\']').val(item['label']);
              $('input[name=\'company_id\']').val(item['value']);
              $.ajax({
                url: 'index.php?route=extension/payment/two/address&company_id=' + encodeURIComponent(item['value']),
                dataType: 'json',
                success: function(json) {
                  var city = json.address.city;
                  var postalCode = json.address.postalCode;
                  var streetAddress = json.address.streetAddress;
                  
                  $('input[name=\'city\']').val(city);
                  $('input[name=\'postcode\']').val(postalCode);
                  $('input[name=\'address_1\']').val(streetAddress);
                  
                }
              });
            }
          });
        }
      }
    });
    
    //--></script>{% endif %}
    ]]>
      </add>
    </operation>
  </file>

  <file path="catalog/controller/checkout/checkout.php">
    <operation error="log">
      <search>
        <![CDATA[$this->load->model('localisation/zone');]]>
      </search>
      <add position="after">
        <![CDATA[
        $zone = $this->model_localisation_zone->getZonesByCountryId($this->request->get['country_id']);
        if (!$this->customer->isLogged()) {
          //Norway(160),UK(222)
            $countryList = array(222,160);
            if($this->config->get('payment_two_status') && in_array($this->request->get['country_id'], $countryList)){
              $zone = array();
            }
        }]]>
      </add>
    </operation>
    <operation error="log">
      <search>
        <![CDATA['zone'              => $this->model_localisation_zone->getZonesByCountryId($this->request->get['country_id']),]]>
      </search>
      <add position="replace">
        <![CDATA['zone'              => $zone,]]>
      </add>
    </operation>
  </file>

  <file path="catalog/controller/checkout/payment_address.php">
    <operation error="log">
      <search>
        <![CDATA[if ($this->request->post['country_id'] == '') {]]>
      </search>
      <add position="before">
        <![CDATA[
    if($this->config->get('payment_two_status') && $this->customer->getAccountType() == 'business'){
      if ($this->request->post['company_id'] == '' && in_array($this->request->post['country_id'], array(222,160))) {
        $json['error']['company'] = 'Please select company from suggested list.';
      }
    }
    ]]>
      </add>
    </operation>
    <operation error="log">
      <search>
        <![CDATA[$this->response->setOutput($this->load->view('checkout/payment_address', $data));]]>
      </search>
      <add position="before">
        <![CDATA[
      if($this->config->get('payment_two_status') && $this->customer->getAccountType() == 'business'){
        $data['two_status'] = $this->config->get('payment_two_status');
        $this->language->load('extension/payment/two');
        $this->load->language('checkout/checkout');
      }
    ]]>
      </add>
    </operation>
  </file>
  <file path="catalog/view/theme/default/template/checkout/payment_address.twig">
    <operation error="log">
      <search>
        <![CDATA[<input type="text" name="company" value="" placeholder="{{ entry_company }}" id="input-payment-company" class="form-control" />]]>
      </search>
      <add position="after">
        <![CDATA[{% if two_status %}</div></div><div class="form-group">
        <label class="col-sm-2 control-label" for="input-payment-company-id">{{ entry_company_id }}</label>
        <div class="col-sm-10"><input readonly placeholder="{{ text_autocomplete }}" type="text" name="company_id" value="{{ company_id }}" id="input-payment-company-id" class="form-control"/>{% endif %}]]>
      </add>
    </operation>
    <operation error="log">
      <search>
        <![CDATA[$('input[name=\'payment_address\']').on('change', function() {]]>
      </search>
      <add position="before">
        <![CDATA[{% if two_status %}
    $( window ).load(function() {
      $('#input-payment-country').change();
    });
    $('#input-payment-country').on('change', function() {
      let united_kingdom_id = 222;
      let norway = 160;
      if(united_kingdom_id == $(this).val() || norway == $(this).val()) {
        var $div = $('#input-payment-company').closest('div[class^="form-group"]').addClass( "required");
      }else {
        var $div = $('#input-payment-company').closest('div[class^="form-group"]').removeClass( "required");
      }
    });
    $('#input-payment-company').on('keyup', function() {
      let united_kingdom_id = 222;
      let norway = 160;
      var countrycheck = $('#input-payment-country').val();
      var comapnyname = $('#input-payment-company').val();
    
      if((comapnyname).length > 2){
        if(countrycheck!=united_kingdom_id && countrycheck!=norway){
          //alert('Please select country Norway or United Kingdom to search');
        }else {
          $('input[name=\'company\']').parent().find('ul.dropdown-menu').remove();
          $('input[name=\'company\']').autocomplete({
            'source': function(request, response) {
              $.ajax({
                url: 'index.php?route=extension/payment/two/company&company=' + encodeURIComponent(request) + '&country_id=' + encodeURIComponent($('#input-payment-country').val()),
                dataType: 'json',               
                success: function(json) {
                  if(json['success']){
                    json = json.data.items;
                    response($.map(json, function(item) {
                    return {
                      label: item['name'],
                      value: item['id']
                    }
                    }));
                  }
                }
              });
            },
            'select': function(item) {
              $('input[name=\'company\']').val(item['label']);
              $('input[name=\'company_id\']').val(item['value']);
              $.ajax({
                url: 'index.php?route=extension/payment/two/address&company_id=' + encodeURIComponent(item['value']),
                dataType: 'json',
                success: function(json) {
                  var city = json.address.city;
                  var postalCode = json.address.postalCode;
                  var streetAddress = json.address.streetAddress;
                  
                  $('input[name=\'city\']').val(city);
                  $('input[name=\'postcode\']').val(postalCode);
                  $('input[name=\'address_1\']').val(streetAddress);
                  
                }
              });
            }
          });
        }
      }
    });{% endif %}
    ]]>
      </add>
    </operation>
  </file>
  <file path="catalog/controller/checkout/shipping_address.php">
  <operation error="log">
      <search>
        <![CDATA[if ($this->request->post['country_id'] == '') {]]>
      </search>
      <add position="before">
        <![CDATA[
      if($this->config->get('payment_two_status') && $this->customer->getAccountType() == 'business'){
        if ($this->request->post['company_id'] == '' && in_array($this->request->post['country_id'], array(222,160))) {
          $json['error']['company'] = 'Please select company from suggested list.';
        }
      }
    ]]>
      </add>
    </operation>
    <operation error="log">
      <search>
        <![CDATA[$this->response->setOutput($this->load->view('checkout/shipping_address', $data));]]>
      </search>
      <add position="before">
        <![CDATA[
      if($this->config->get('payment_two_status') && $this->customer->getAccountType() == 'business'){
        $data['two_status'] = $this->config->get('payment_two_status');
        $this->language->load('extension/payment/two');
        $this->load->language('checkout/checkout');
      }
    ]]>
      </add>
    </operation>
  </file>
  <file path="catalog/view/theme/default/template/checkout/shipping_address.twig">
    <operation error="log">
      <search>
        <![CDATA[<input type="text" name="company" value="" placeholder="{{ entry_company }}" id="input-shipping-company" class="form-control" />]]>
      </search>
      <add position="after">
        <![CDATA[{% if two_status %}</div></div><div class="form-group">
        <label class="col-sm-2 control-label" for="input-shipping-company-id">{{ entry_company_id }}</label>
        <div class="col-sm-10"><input readonly placeholder="{{ text_autocomplete }}" type="text" name="company_id" value="{{ company_id }}" id="input-payment-company-id" class="form-control"/>{% endif %}]]>
      </add>
    </operation>
    <operation error="log">
      <search>
        <![CDATA[$('#collapse-shipping-address select[name=\'country_id\']').on('change', function() {]]>
      </search>
      <add position="before">
        <![CDATA[{% if two_status %}
    $( window ).load(function() {
      $('#input-shipping-country').change();
    });
    $('#input-shipping-country').on('change', function() {
      let united_kingdom_id = 222;
      let norway = 160;
      if(united_kingdom_id == $(this).val() || norway == $(this).val()) {
        var $div = $('#input-shipping-company').closest('div[class^="form-group"]').addClass( "required");
      }else {
        var $div = $('#input-shipping-company').closest('div[class^="form-group"]').removeClass( "required");
      }
    });
    $('#input-shipping-company').on('keyup', function() {
      let united_kingdom_id = 222;
      let norway = 160;
      var countrycheck = $('#input-shipping-country').val();
      var comapnyname = $('#input-shipping-company').val();
    
      if((comapnyname).length > 2){
        if(countrycheck!=united_kingdom_id && countrycheck!=norway){
          //alert('Please select country Norway or United Kingdom to search');
        }else {
          $('input[name=\'company\']').parent().find('ul.dropdown-menu').remove();
          $('input[name=\'company\']').autocomplete({
            'source': function(request, response) {
              $.ajax({
                url: 'index.php?route=extension/payment/two/company&company=' + encodeURIComponent(request) + '&country_id=' + encodeURIComponent($('#input-shipping-country').val()),
                dataType: 'json',               
                success: function(json) {
                  if(json['success']){
                    json = json.data.items;
                    response($.map(json, function(item) {
                    return {
                      label: item['name'],
                      value: item['id']
                    }
                    }));
                  }
                }
              });
            },
            'select': function(item) {
              $('input[name=\'company\']').val(item['label']);
              $('input[name=\'company_id\']').val(item['value']);
              $.ajax({
                url: 'index.php?route=extension/payment/two/address&company_id=' + encodeURIComponent(item['value']),
                dataType: 'json',
                success: function(json) {
                  var city = json.address.city;
                  var postalCode = json.address.postalCode;
                  var streetAddress = json.address.streetAddress;
                  
                  $('input[name=\'city\']').val(city);
                  $('input[name=\'postcode\']').val(postalCode);
                  $('input[name=\'address_1\']').val(streetAddress);
                  
                }
              });
            }
          });
        }
      }
    });{% endif %}
    ]]>
      </add>
    </operation>
  </file>


  <file path="catalog/controller/checkout/guest.php">
    <operation error="log">
      <search>
        <![CDATA[$this->response->setOutput($this->load->view('checkout/guest', $data));]]>
      </search>
      <add position="before">
        <![CDATA[
      if($this->config->get('payment_two_status')){
        $data['two_status'] = $this->config->get('payment_two_status');
        $this->load->language('extension/payment/two');

        if (isset($this->session->data['guest']['account_type'])) {
          $data['account_type'] = $this->session->data['guest']['account_type'];
        } else {
          $data['account_type'] = '';
        }

        if (isset($this->session->data['payment_address']['company_id'])) {
          $data['company_id'] = $this->session->data['payment_address']['company_id'];
        } else {
          $data['company_id'] = '';
        }

        $this->load->language('checkout/checkout');
      }
    ]]>
      </add>
    </operation>
    <operation error="log">
      <search>
        <![CDATA[if ($this->request->post['country_id'] == '') {]]>
      </search>
      <add position="before">
        <![CDATA[
      if($this->config->get('payment_two_status') && $this->request->post['account_type'] == 'business'){
        if ($this->request->post['company_id'] == '' && in_array($this->request->post['country_id'], array(222,160))) {
          $json['error']['company'] = 'Please select company from suggested list.';
        }
      }
    ]]>
      </add>
    </operation>
    <operation error="log">
      <search>
        <![CDATA[$this->session->data['payment_address']['company'] = $this->request->post['company'];]]>
      </search>
      <add position="after">
        <![CDATA[
      if($this->config->get('payment_two_status')){
        $this->session->data['payment_address']['company_id'] = $this->request->post['company_id'];
        $this->session->data['guest']['account_type'] = $this->request->post['account_type'];
      }
    ]]>
      </add>
    </operation>
  </file>
  <file path="catalog/view/theme/default/template/checkout/guest.twig">
    <operation error="log">
      <search>
        <![CDATA[<input type="text" name="company" value="{{ company }}" placeholder="{{ entry_company }}" id="input-payment-company" class="form-control" />]]>
      </search>
      <add position="after">
        <![CDATA[{% if two_status %}</div>
        <div class="form-group">
        <label class="control-label" for="input-payment-company-id">{{ entry_company_id }}</label>
        <input readonly placeholder="{{ text_autocomplete }}" type="text" name="company_id" value="{{ company_id }}" id="input-payment-company-id" class="form-control"/>{% endif %}]]>
      </add>
    </operation>
  <operation error="log">
      <search>
        <![CDATA[<input type="text" name="telephone" value="{{ telephone }}" placeholder="{{ entry_telephone }}" id="input-payment-telephone" class="form-control" />]]>
      </search>
      <add position="after">
        <![CDATA[{% if two_status %}</div>
          <div class="form-group required">
            <label class="control-label" for="input-payment-account-type">{{ entry_account_type }}</label>
            <div class="">
              {% if account_type == 'personal' %}
              <label class="radio-inline">
                <input type="radio" name="account_type" value="personal" checked="checked" />
                {{ text_personal }}</label>
              <label class="radio-inline">
                <input type="radio" name="account_type" value="business" />
                {{ text_business }}</label>
              {% else %}
              <label class="radio-inline">
                <input type="radio" name="account_type" value="personal" />
                {{ text_personal }}</label>
              <label class="radio-inline">
                <input type="radio" name="account_type" value="business" checked="checked" />
                {{ text_business }}</label>
              {% endif %}
            </div>{% endif %}
    ]]>
      </add>
    </operation>
    <operation error="log">
      <search>
        <![CDATA[$('#collapse-payment-address input[name=\'customer_group_id\']').on('change', function() {]]>
      </search>
      <add position="before">
        <![CDATA[{% if two_status %}
        countryTel();
    $( window ).load(function() {
      $('#input-payment-country').change();
      $('input[name=\'account_type\']').change();
    });
    $('#input-payment-country').on('change', function() {
      countryTel();
      let united_kingdom_id = 222;
      let norway = 160;
      if(united_kingdom_id == $(this).val() || norway == $(this).val()) {
        var $div = $('#input-payment-company').closest('div[class^="form-group"]').addClass( "required");
        if($('input[name=\'account_type\']:checked').val() == 'personal'){
          var $div = $('#input-payment-company').closest('div[class^="form-group"]').removeClass( "required");
        }
      }else {
        var $div = $('#input-payment-company').closest('div[class^="form-group"]').removeClass( "required");
      }
    });
    $('input[name=\'account_type\']').on('change', function() {
      if($(this).val() == 'personal'){
        $div = $('#input-payment-company-id').closest('div[class^="form-group"]').hide();
        var $div = $('#input-payment-company').closest('div[class^="form-group"]').removeClass( "required");
      } else {
        $div = $('#input-payment-company-id').closest('div[class^="form-group"]').show();
        var $div = $('#input-payment-company').closest('div[class^="form-group"]').addClass( "required");
        let united_kingdom_id = 222;
        let norway = 160;
        if(united_kingdom_id == $('#input-payment-country').val() || norway == $('#input-payment-country').val()) {
          var $div = $('#input-payment-company').closest('div[class^="form-group"]').addClass( "required");
        }else {
          var $div = $('#input-payment-company').closest('div[class^="form-group"]').removeClass( "required");
        }
      }
    });
    $('#input-payment-company').on('keyup', function() {
      if($('input[name=\'account_type\']:checked').val() == 'personal'){
        return false;
      }
      let united_kingdom_id = 222;
      let norway = 160;
      var countrycheck = $('#input-payment-country').val();
      var comapnyname = $('#input-payment-company').val();
    
      if((comapnyname).length > 2){
        if(countrycheck!=united_kingdom_id && countrycheck!=norway){
          //alert('Please select country Norway or United Kingdom to search');
        }else {
          $('input[name=\'company\']').parent().find('ul.dropdown-menu').remove();
          $('input[name=\'company\']').autocomplete({
            'source': function(request, response) {
              $.ajax({
                url: 'index.php?route=extension/payment/two/company&company=' + encodeURIComponent(request) + '&country_id=' + encodeURIComponent($('#input-payment-country').val()),
                dataType: 'json',               
                success: function(json) {
                  if(json['success']){
                    json = json.data.items;
                    response($.map(json, function(item) {
                    return {
                      label: item['name'],
                      value: item['id']
                    }
                    }));
                  }
                }
              });
            },
            'select': function(item) {
              $('input[name=\'company\']').val(item['label']);
              $('input[name=\'company_id\']').val(item['value']);
              $.ajax({
                url: 'index.php?route=extension/payment/two/address&company_id=' + encodeURIComponent(item['value']),
                dataType: 'json',
                success: function(json) {
                  var city = json.address.city;
                  var postalCode = json.address.postalCode;
                  var streetAddress = json.address.streetAddress;
                  
                  $('input[name=\'city\']').val(city);
                  $('input[name=\'postcode\']').val(postalCode);
                  $('input[name=\'address_1\']').val(streetAddress);
                  
                }
              });
            }
          });
        }
      }
    });{% endif %}
    ]]>
      </add>
    </operation>
  </file>

  <file path="catalog/controller/checkout/register.php">
    <operation error="log">
      <search>
        <![CDATA[$this->response->setOutput($this->load->view('checkout/register', $data));]]>
      </search>
      <add position="before">
        <![CDATA[
      if($this->config->get('payment_two_status')){
        $data['two_status'] = $this->config->get('payment_two_status');
        $this->load->language('extension/payment/two');

        $this->load->language('checkout/checkout');
      }
    ]]>
      </add>
    </operation>
    <operation error="log">
      <search>
        <![CDATA[if ($this->request->post['country_id'] == '') {]]>
      </search>
      <add position="before">
        <![CDATA[
      if($this->config->get('payment_two_status') && $this->request->post['account_type'] == 'business'){
        if ($this->request->post['company_id'] == '' && in_array($this->request->post['country_id'], array(222,160))) {
          $json['error']['company'] = 'Please select company from suggested list.';
        }
      }
    ]]>
      </add>
    </operation>
    <operation error="log">
      <search>
        <![CDATA[if ($this->request->post['country_id'] == '') {]]>
      </search>
      <add position="before">
        <![CDATA[
      if($this->config->get('payment_two_status') && $this->request->post['account_type'] == 'business'){
        if ($this->request->post['company_id'] == '' && in_array($this->request->post['country_id'], array(222,160))) {
          $json['error']['company'] = 'Please select company from suggested list.';
        }
      }
    ]]>
      </add>
    </operation>
  </file>
  <file path="catalog/view/theme/default/template/checkout/register.twig">
    <operation error="log">
      <search>
        <![CDATA[<input type="text" name="company" value="" placeholder="{{ entry_company }}" id="input-payment-company" class="form-control" />]]>
      </search>
      <add position="after">
        <![CDATA[{% if two_status %}</div>
        <div class="form-group">
        <label class="control-label" for="input-payment-company-id">{{ entry_company_id }}</label>
        <input readonly placeholder="{{ text_autocomplete }}" type="text" name="company_id" value="" id="input-payment-company-id" class="form-control"/>{% endif %}]]>
      </add>
    </operation>
  <operation error="log">
      <search>
        <![CDATA[<input type="text" name="telephone" value="" placeholder="{{ entry_telephone }}" id="input-payment-telephone" class="form-control" />]]>
      </search>
      <add position="after">
        <![CDATA[{% if two_status %}</div>
          <div class="form-group required">
            <label class="control-label" for="input-payment-account-type">{{ entry_account_type }}</label>
            <div class="">
              {% if account_type == 'personal' %}
              <label class="radio-inline">
                <input type="radio" name="account_type" value="personal" checked="checked" />
                {{ text_personal }}</label>
              <label class="radio-inline">
                <input type="radio" name="account_type" value="business" />
                {{ text_business }}</label>
              {% else %}
              <label class="radio-inline">
                <input type="radio" name="account_type" value="personal" />
                {{ text_personal }}</label>
              <label class="radio-inline">
                <input type="radio" name="account_type" value="business" checked="checked" />
                {{ text_business }}</label>
              {% endif %}
            </div>{% endif %}
    ]]>
      </add>
    </operation>
    <operation error="log">
      <search>
        <![CDATA[$('#collapse-payment-address input[name=\'customer_group_id\']').on('change', function() {]]>
      </search>
      <add position="before">
        <![CDATA[{% if two_status %}
        countryTel();
    $( window ).load(function() {
      $('#input-payment-country').change();
      $('input[name=\'account_type\']').change();
    });
    $('#input-payment-country').on('change', function() {
      countryTel();
      let united_kingdom_id = 222;
      let norway = 160;
      if(united_kingdom_id == $(this).val() || norway == $(this).val()) {
        var $div = $('#input-payment-company').closest('div[class^="form-group"]').addClass( "required");
        if($('input[name=\'account_type\']:checked').val() == 'personal'){
          var $div = $('#input-payment-company').closest('div[class^="form-group"]').removeClass( "required");
        }
      }else {
        var $div = $('#input-payment-company').closest('div[class^="form-group"]').removeClass( "required");
      }
    });
    $('input[name=\'account_type\']').on('change', function() {
      if($(this).val() == 'personal'){
        $div = $('#input-payment-company-id').closest('div[class^="form-group"]').hide();
        var $div = $('#input-payment-company').closest('div[class^="form-group"]').removeClass( "required");
      } else {
        $div = $('#input-payment-company-id').closest('div[class^="form-group"]').show();
        var $div = $('#input-payment-company').closest('div[class^="form-group"]').addClass( "required");
        let united_kingdom_id = 222;
        let norway = 160;
        if(united_kingdom_id == $('#input-payment-country').val() || norway == $('#input-payment-country').val()) {
          var $div = $('#input-payment-company').closest('div[class^="form-group"]').addClass( "required");
        }else {
          var $div = $('#input-payment-company').closest('div[class^="form-group"]').removeClass( "required");
        }
      }
    });
    $('#input-payment-company').on('keyup', function() {
      if($('input[name=\'account_type\']:checked').val() == 'personal'){
        return false;
      }
      let united_kingdom_id = 222;
      let norway = 160;
      var countrycheck = $('#input-payment-country').val();
      var comapnyname = $('#input-payment-company').val();
    
      if((comapnyname).length > 2){
        if(countrycheck!=united_kingdom_id && countrycheck!=norway){
          //alert('Please select country Norway or United Kingdom to search');
        }else {
          $('input[name=\'company\']').parent().find('ul.dropdown-menu').remove();
          $('input[name=\'company\']').autocomplete({
            'source': function(request, response) {
              $.ajax({
                url: 'index.php?route=extension/payment/two/company&company=' + encodeURIComponent(request) + '&country_id=' + encodeURIComponent($('#input-payment-country').val()),
                dataType: 'json',               
                success: function(json) {
                  if(json['success']){
                    json = json.data.items;
                    response($.map(json, function(item) {
                    return {
                      label: item['name'],
                      value: item['id']
                    }
                    }));
                  }
                }
              });
            },
            'select': function(item) {
              $('input[name=\'company\']').val(item['label']);
              $('input[name=\'company_id\']').val(item['value']);
              $.ajax({
                url: 'index.php?route=extension/payment/two/address&company_id=' + encodeURIComponent(item['value']),
                dataType: 'json',
                success: function(json) {
                  var city = json.address.city;
                  var postalCode = json.address.postalCode;
                  var streetAddress = json.address.streetAddress;
                  
                  $('input[name=\'city\']').val(city);
                  $('input[name=\'postcode\']').val(postalCode);
                  $('input[name=\'address_1\']').val(streetAddress);
                  
                }
              });
            }
          });
        }
      }
    });{% endif %}
    ]]>
      </add>
    </operation>
  </file>
  <file path="catalog/view/theme/default/template/checkout/checkout.twig">
    <operation error="log">
      <search>
        <![CDATA[#collapse-shipping-address input[type=\'text\']]]>
      </search>
      <add position="replace">
        <![CDATA[#collapse-shipping-address input[type=\'text\'], #collapse-shipping-address input[type=\'hidden\']]]>
      </add>
    </operation>
    <operation error="log">
      <search>
        <![CDATA[{{ footer }}]]>
      </search>
      <add position="before">
        <![CDATA[
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css" />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
        <script type="text/javascript">
        function countryTel() {
          var config_country = $('#input-payment-country').val();
          var billingPhoneInput;
          let billingPhoneInputField = document.querySelector("#input-payment-telephone");
          if(config_country == 160 || config_country == '160'){
            billingPhoneInput = window.intlTelInput(billingPhoneInputField, {
              preferredCountries: ["no", "gb"],
              utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"
            });
          } else {
            billingPhoneInput = window.intlTelInput(billingPhoneInputField, {
              preferredCountries: ["gb", "no"],
              utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"
            });
          }
          if ($('#input-payment-telephone')) {
              billingPhoneInput.setNumber($('#input-payment-telephone').val());
          }
        }
        </script>
        <style type="text/css">
        .iti--allow-dropdown{display: block;}
        .iti__selected-flag{height: 35px;}
        </style> 
      ]]>
      </add>
    </operation>
  </file>
  <file path="admin/controller/sale/order.php">
    <operation error="log">
      <search>
        <![CDATA[$data['payment_method'] = $order_info['payment_method'];]]>
      </search>
      <add position="after">
        <![CDATA[$data['payment_code'] = $order_info['payment_code'];]]>
      </add>
    </operation>
  </file>
  <file path="admin/view/template/sale/order_info.twig">
    <operation error="log">
      <search>
        <![CDATA[<div id="history"></div>]]>
      </search>
      <add position="before">
        <![CDATA[<div id="two"></div>]]>
      </add>
    </operation>
    <operation error="log">
      <search>
        <![CDATA[$('#button-history').on('click', function() {]]>
      </search>
      <add position="before">
        <![CDATA[{% if payment_code == 'two' %}$('#two').load('index.php?route=extension/payment/two/history&user_token={{ user_token }}&order_id={{ order_id }}&order_status_id=' + encodeURIComponent($('select[name=\'order_status_id\']').val()));{% endif %}]]>
      </add>
    </operation>
    <operation error="log">
      <search>
        <![CDATA[$('#button-history').on('click', function() {]]>
      </search>
      <add position="after">
        <![CDATA[{% if payment_code == 'two' %}
      $.ajax({
        url: 'index.php?route=extension/payment/two/updateOrder&user_token={{ user_token }}&order_id={{ order_id }}',
        type: 'post',
        dataType: 'json',
        data: 'order_status_id=' + encodeURIComponent($('select[name=\'order_status_id\']').val()) + '&notify=' + ($('input[name=\'notify\']').prop('checked') ? 1 : 0) + '&override=' + ($('input[name=\'override\']').prop('checked') ? 1 : 0) + '&append=' + ($('input[name=\'append\']').prop('checked') ? 1 : 0) + '&comment=' + encodeURIComponent($('textarea[name=\'comment\']').val()),
        beforeSend: function() {
          $('#button-history').button('loading');
        },
        complete: function() {
          $('#button-history').button('reset');
        },
        success: function(json) {
          $('.alert-dismissible').remove();
          if (json['error']) {
            $('#two').before('<div class="alert alert-danger alert-dismissible"><i class="fa fa-exclamation-circle"></i> ' + json['error'] + ' <button type="button" class="close" data-dismiss="alert">&times;</button></div>');
          }
          if (json['success']) {          
            $('#two').load('index.php?route=extension/payment/two/history&user_token={{ user_token }}&order_id={{ order_id }}');
            callHostory();
          }
        },
        error: function(xhr, ajaxOptions, thrownError) {
          alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
      });
    });
    function callHostory(){
      $.ajax({
        url: '{{ catalog }}index.php?route=api/order/history&api_token={{ api_token }}&store_id={{ store_id }}&order_id={{ order_id }}',
        type: 'post',
        dataType: 'json',
        data: 'order_status_id=' + encodeURIComponent($('select[name=\'order_status_id\']').val()) + '&notify=' + ($('input[name=\'notify\']').prop('checked') ? 1 : 0) + '&override=' + ($('input[name=\'override\']').prop('checked') ? 1 : 0) + '&append=' + ($('input[name=\'append\']').prop('checked') ? 1 : 0) + '&comment=' + encodeURIComponent($('textarea[name=\'comment\']').val()),
        beforeSend: function() {
          $('#button-history').button('loading');
        },
        complete: function() {
          $('#button-history').button('reset');
        },
        success: function(json) {
          $('.alert-dismissible').remove();

          if (json['error']) {
            $('#history').before('<div class="alert alert-danger alert-dismissible"><i class="fa fa-exclamation-circle"></i> ' + json['error'] + ' <button type="button" class="close" data-dismiss="alert">&times;</button></div>');
          }

          if (json['success']) {
            $('#history').load('index.php?route=sale/order/history&user_token={{ user_token }}&order_id={{ order_id }}');
            {% if payment_code == 'two' %}$('#two').load('index.php?route=extension/payment/two/history&user_token={{ user_token }}&order_id={{ order_id }}&order_status_id=' + encodeURIComponent($('select[name=\'order_status_id\']').val()));{% endif %}
            $('#history').before('<div class="alert alert-success alert-dismissible"><i class="fa fa-check-circle"></i> ' + json['success'] + ' <button type="button" class="close" data-dismiss="alert">&times;</button></div>');

            $('textarea[name=\'comment\']').val('');
          }
        },
        error: function(xhr, ajaxOptions, thrownError) {
          alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
        }
      });
    }
    $('#button-xyz').on('click', function() {
    {% endif %}]]>
      </add>
    </operation>
  </file>
  <file path="admin/view/template/sale/order_form.twig">
    <operation error="log">
      <search>
        <![CDATA[$('#tab-payment input[name=\'postcode\']').closest('.form-group').removeClass('required');]]>
      </search>
      <add position="after" offset="1">
        <![CDATA[var country = $('#tab-payment select[name=\'country_id\']').val();
      if(country == 160 || country == 222){
        json['zone'] = '';
      }]]>
      </add>
    </operation>
    <operation error="log">
      <search>
        <![CDATA[$('#tab-shipping input[name=\'postcode\']').closest('.form-group').removeClass('required');]]>
      </search>
      <add position="after" offset="1">
        <![CDATA[var country = $('#tab-shipping select[name=\'country_id\']').val();
      if(country == 160 || country == 222){
        json['zone'] = '';
      }]]>
      </add>
    </operation>
    <operation error="log">
      <search>
        <![CDATA[if (json['order_id']) {]]>
      </search>
      <add position="before">
        <![CDATA[if (json['success']) {
        $.ajax({
          url: 'index.php?route=extension/payment/two/editOrder&user_token={{ user_token }}&order_id='+$('input[name=\'order_id\']').val(),
          type: 'post',
          crossDomain: true,
          success: function(message) {
            $('#content > .container-fluid').prepend(message);
          },
          error: function(xhr, ajaxOptions, thrownError) {
            alert(thrownError + "\r\n" + xhr.statusText + "\r\n" + xhr.responseText);
          }
        });
      }]]>
      </add>
    </operation>
    
  </file>
</modification>
